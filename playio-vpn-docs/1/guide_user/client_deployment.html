<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy VPN client :: Play-IoT Documentation</title>
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">Play-IoT Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="playio-vpn-docs" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">PlayIO VPN Docs</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">VPN Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../OVERVIEW.html">How it set up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../guide_dev/SETUP.html">Setup Development Environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../guide_dev/DEV.html">Developing VPN tools</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">User Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="VPNC_README.html">Client CLI</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cmd.html">Secret Tool</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="client_deployment.html">Deploying</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VPN_DDNS.html">Dynamic Client Name Resolving</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">PlayIO VPN Docs</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">PlayIO VPN Docs</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">PlayIO VPN Docs</a></li>
    <li>User Guide</li>
    <li><a href="client_deployment.html">Deploying</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/play-iot/iot-vpn/edit/feature/documentation-pages/docs/modules/guide_user/pages/client_deployment.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Deploy VPN client</h1>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a>Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installation"><a class="anchor" href="#_installation"></a>Installation</h3>
<div class="ulist">
<ul>
<li>
<p>Download the latest version <code>vpnc-deployer-cli</code> in <a href="https://github.com/play-iot/iot-vpn/releases">playio-vpn/releases</a> and copy to anywhere in <strong>YOUR LINUX COMPUTER</strong></p>
</li>
<li>
<p>Install <a href="https://docs.docker.com/engine/install"><code>docker</code></a> and <a href="https://docs.docker.com/compose/install/"><code>docker-compose</code></a></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For convenient, setup download tool <a href="https://github.com/zero88/gh-release-downloader">ghrd</a> to quick download artifact by version on GitHub.
This is setup script for <code>Ubuntu</code>/<code>Debian</code> distro</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export GHRDVER=1.1.2 &amp;&amp; sudo curl -L https://github.com/zero88/gh-release-downloader/releases/download/v$GHRDVER/ghrd -o /usr/local/bin/ghrd \
  &amp;&amp; sudo chmod +x /usr/local/bin/ghrd \
  &amp;&amp; sudo ln -sf /usr/local/bin/ghrd /usr/bin/ghrd \
  &amp;&amp; sudo apt install jq -y \
  &amp;&amp; unset GHRDVER</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_download_tool"><a class="anchor" href="#_download_tool"></a>Download tool</h4>
<div class="paragraph">
<p>This is a script that using <code>ghrd</code>.
For example: <code>VPNCVER=v0.9.4</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export VPNCVER=v0.9.4 \
   &amp;&amp; ghrd vpnc-deployer-cli -r vpnc-deployer/$VPNCVER -o /tmp play-iot/iot-vpn \
   &amp;&amp; sudo mkdir -p /app \
   &amp;&amp; sudo mv /tmp/vpnc-deployer-cli /app/vpnc-deployer-cli \
   &amp;&amp; sudo ln -sf /app/vpnc-deployer-cli /usr/local/bin/vpnc-deployer-cli \
   &amp;&amp; unset VPNCVER</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_workflow"><a class="anchor" href="#_workflow"></a>Workflow</h3>
<div class="paragraph">
<p>Assume sample workflow inputs:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Input</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deployer_dir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/app/vpnc-deployer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A deployment dir in your computer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>vpnc_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.9.4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A VPNC release version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>customer_code</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enviro</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An sample for customer code</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>private_cloud_dns</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>proxy.cloud.enviro</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A private cloud DNS for each customer.
If customer have not yet private cloud, use <code>google.com</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Repeat this workflow for each customer with update corresponding to <code>customer_code</code> and <code>private_cloud_dns</code> If new <code>vpnc</code> version is released, need to update also.</p>
</div>
<div class="sect3">
<h4 id="_init_step"><a class="anchor" href="#_init_step"></a>Init step</h4>
<div class="paragraph">
<p>This step use information above.
Please check it carefully.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cat &gt;&gt; ~/.bashrc &lt;&lt;EOL
export VPNC_DEPLOYER=/app/vpnc-deployer
EOL
$ ./vpnc-deployer-cli -r 0.9.4 -p proxy.cloud.enviro -e enviro init
Validating dependencies...
Dependencies OK!!!
Validating arguments...
Arguments OK!!!
Preparing deployment location [/app/vpnc-deployer]...
Downloading VPNC binary for arch[amd64] to [/app/vpnc-deployer/enviro-vpnc-amd64]...
Downloading VPNC binary for arch[armv7] to [/app/vpnc-deployer/enviro-vpnc-armv7]...
Downloading VPNC binary for arch[arm64] to [/app/vpnc-deployer/enviro-vpnc-arm64]...
Prepared OK!!!
Generating Docker compose stack...
Generated OK: /app/vpnc-deployer/enviro-docker-compose.yml
Generated OK: /app/vpnc-deployer/inventory/enviro-hosts.yml
Generated OK: /app/vpnc-deployer/files/enviro-credentials.json
Please update remote device connection in '/app/vpnc-deployer/inventory/enviro-hosts.yml'
Please update VPN credentials in '/app/vpnc-deployer/files/enviro-credentials.json'
Then invoke './vpnc-deployer-cli &lt;command&gt;' in which command can be one of [setup,state,rollout,extend,undeploy]
DONE!!!</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_target_machine_hosts"><a class="anchor" href="#_update_target_machine_hosts"></a>Update target machine hosts</h3>
<div class="paragraph">
<p>Update <code>&lt;customer-code&gt;-hosts.yml</code> as <code>init</code> step output.
In sample context is: <code>/app/vpnc-deployer/inventory/enviro-hosts.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">all:
children:
  device:
    hosts:
      &lt;device_name_1&gt;:
        ansible_host: &lt;device_ip_1&gt;
      &lt;device_name_2&gt;:
        ansible_host: &lt;device_ip_2&gt;
        ansible_port: &lt;device_port_2&gt;
        ansible_user: &lt;device_user_2&gt;
        ansible_password: &lt;device_password_2&gt;
    vars:
      ansible_port: &lt;device_ssh_port_for_all_hosts&gt;
      ansible_user: &lt;device_username_for_all_hosts&gt;
      ansible_password: &lt;device_user_password_for_all_hosts&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Importance</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>device_name_*</code> to vpn user format.
For example: <code>n000001</code>, <code>n000002</code></p>
</li>
<li>
<p>Replace <code>device_ip_*</code> to host ip that corresponding to <code>vpn_user</code>.
For example: <code>192.168.10.15</code> for <code>n000001</code>.</p>
</li>
<li>
<p>Replace <code>device_port_*</code> to SSH port that corresponding to <code>vpn_user</code>.
For example: <code>2022</code> for <code>n000001</code>.</p>
</li>
<li>
<p>Replace <code>device_user_*</code> to SSH user in <code>sudo</code> role that corresponding to <code>vpn_user</code>.
For example: <code>pi</code> for <code>n000001</code>.</p>
</li>
<li>
<p>Replace <code>device_password_*</code> to SSH password that corresponding to <code>vpn_user</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_update_target_vpn_credentials"><a class="anchor" href="#_update_target_vpn_credentials"></a>Update target VPN credentials</h3>
<div class="paragraph">
<p>Update <code>&lt;customer-code&gt;-credentials.json</code> as <code>init</code> step output.
In sample context is: <code>/app/vpnc-deployer/enviro-credentials.json</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
"&lt;device_name&gt;": {
  "vpn_server": "&lt;vpn_server&gt;",
  "vpn_port": "&lt;vpn_port&gt;",
  "vpn_hub": "&lt;customer_code&gt;",
  "vpn_account": "&lt;customer_code&gt;",
  "vpn_auth_type": "&lt;cert|password&gt;",
  "vpn_user": "&lt;vpn_user&gt;",
  "vpn_password": "&lt;vpn_password&gt;",
  "vpn_cert_key": "&lt;vpn_cert_key&gt;",
  "vpn_private_key": "&lt;vpn_private_key&gt;"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Importance</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can test by your local computer with <code>user</code>/<code>password</code></p>
</li>
<li>
<p>In <code>production</code>, this file will be provided by administrator per customer</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_setup_vpn_client"><a class="anchor" href="#_setup_vpn_client"></a>Setup VPN client</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./vpnc-deployer.sh -e enviro setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will show output to console, then don&#8217;t close it by <code>Ctrl+C</code> After the progress finished, it will show something like that</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vpnc-deployer_1  | PLAY RECAP *********************************************************************
vpnc-deployer_1  | n000002                    : ok=14   changed=3    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
vpnc-deployer_1  | n000003                    : ok=14   changed=3    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If output show <code>unreachable=1</code>, please check your connection to target devices (<code>ip</code>/<code>port</code>/<code>username</code>/<code>password</code>)</p>
</li>
<li>
<p>If output show <code>failed=1</code>, please copy a log file in <code>/tmp/out/ansible.log</code> then send to @zero88`</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development"><a class="anchor" href="#_development"></a>Development</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-inventory --graph</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run this playbook first to ensure the default <code>python</code> path exists on target hosts for ansible to lookup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook wf-ensure-python.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook wf-vpnc-rollout.yml -e 'debug=1' -e '{"args_vpn_state_test_domains": ["google.com"]}'</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_docker"><a class="anchor" href="#_docker"></a>Docker</h3>
<div class="ulist">
<ul>
<li>
<p>See <code>docker-compose</code> dev version <a href="https://github.com/play-iot/iot-vpn/blob/main/docker/vpnc-deployer-dkc.yml">here</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
